<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>txt2WebGame</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/webp" sizes="16x16" href="https://onliniak.github.io/Archipelag-dev/favicon.webp">
    <script>
let request = window.location.pathname
let article = document.getElementsByTagName('article')
let cacche = caches.match(request, {
  ignoreSearch: true
})

cacche.then(function(response) {
  if (response != undefined) {
    article[0].appendChild(cacche)
  } else {
    fetchPartials(`/${request.substring(16)}`)
      .then(json => render(json))
  }
})
    </script>
</head>

<body>
    <main style="display: grid; grid-template-columns: 2fr 5fr 2fr">
        <section></section>
        <article></article>
        <section></section>
    </main>
    <script>
        
async function fetchPartials(currentPage) {
  let origin   = window.location.origin
  let skipFile = request.substring(0, request.lastIndexOf('/'));
  let response = await fetch(`${origin}${skipFile}/json${currentPage}.json`)
  return await response.json()
}
        
async function render(json) {
  let parsed = await json
  let template = parsed.template
  let currentHtml = new XMLSerializer().serializeToString(document)
  
  if (template === 'default') {
    defaultTemplate(parsed.description, 'world')
    caches.open(request.substring(16)).then(function(cache) {
      cache.put(request, currentHtml);
    });  
  }
}

function defaultTemplate(intro, content, img = null) {
    let div = document.createElement("div")
    let description = document.createTextNode(intro);
    let firstDiv = div.appendChild(description)
    
  if (img) {
    let newImg = Image(800, 600)
    newImg.loading = 'lazy'
    newImg.src = img
    document.getElementsByTagName('article')[0]
        .appendChild(newImg)
  }
  document.getElementsByTagName('article')[0]
    .appendChild(firstDiv)
}
    </script>
</body>

</html>
