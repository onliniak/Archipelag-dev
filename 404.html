<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>txt2WebGame</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/webp" sizes="16x16" href="https://onliniak.github.io/Archipelag-dev/favicon.webp">
</head>

<body>
    <main style="display: grid; grid-template-columns: 2fr 5fr 2fr">
        <section></section>
        <article></article>
        <section></section>
    </main>
        <script>
let request = window.location.pathname
let fileName = request.substring(16)
let article = document.getElementsByTagName('article')

class Store {
  constructor(dbName = 'keyval-store', storeName = 'keyval') {
    this.storeName = storeName
    this._dbp = new Promise((resolve, reject) => {
      const openreq = indexedDB.open(dbName, 1)
      openreq.onerror = () => reject(openreq.error)
      openreq.onsuccess = () => resolve(openreq.result)
      // First time setup: create an empty object store
      openreq.onupgradeneeded = () => {
        openreq.result.createObjectStore(storeName)
      }
    })
  }
  _withIDBStore(type, callback) {
    return this._dbp.then(db => new Promise((resolve, reject) => {
      const transaction = db.transaction(this.storeName, type)
      transaction.oncomplete = () => resolve()
      transaction.onabort = transaction.onerror = () => reject(transaction.error)
      callback(transaction.objectStore(this.storeName))
    }))
  }
}
let store
function getDefaultStore() {
  if (!store)
    store = new Store()
  return store
}
function get(key, store = getDefaultStore()) {
  let req
  return store._withIDBStore('readonly', store => {
    req = store.get(key)
  }).then(() => req.result)
}
function set(key, value, store = getDefaultStore()) {
  return store._withIDBStore('readwrite', store => {
    store.put(value, key)
  })
}

let cacche = get(`${fileName}Intro`)
let Img = get(`${fileName}Img`)

cacche.then(function (response) {
  if (response != undefined) {

    div = document.createElement("div")
    div.id = "main"
    description = document.createTextNode(get(`${fileName}Intro`));
    Intro = div.appendChild(description)

    Img.then(function (response) {
      if (response != undefined) {
        newImg = new Image(800, 600)
        newImg.loading = 'lazy'
        newImg.src = response
        document.getElementById('main')
          .appendChild(newImg)
      })

      var sp2 = document.getElementById("main");
      var parentDiv = sp2.parentNode;
      parentDiv.insertBefore(sp1, sp2);
    }

      //div2 = document.createElement("div")
      //mainHtml = document.createTextNode(get(`${fileName}Intro`));
      //Content = div.appendChild(mainHtml)

      document.getElementsByTagName("article")[0]
        .appendChild(Intro)
    } else {
      fetchPartials(fileName)
      .then(json => render(json))
    }
})
    </script>
    <script async>
        
async function fetchPartials(currentPage) {
  let origin   = window.location.origin
  let skipFile = request.substring(0, request.lastIndexOf('/'));
  let response = await fetch(`${origin}${skipFile}/json/${currentPage}.json`)
  return await response.json()
}
        
async function render(json) {
  let parsed = await json
  let template = parsed.template
  
  if (template === 'default') {
    defaultTemplate(parsed.description, 'world')
  }
}

async function defaultTemplate(intro, content, img = null) {
    let div = document.createElement("div")
    let description = document.createTextNode(intro);
    let firstDiv = div.appendChild(description)
    
  if (img) {
    let newImg = new Image(800, 600)
    newImg.loading = 'lazy'
    newImg.src = img
    document.getElementsByTagName('article')[0]
        .appendChild(newImg)
    set(`${fileName}Img`, img)
  }
  document.getElementsByTagName('article')[0]
    .appendChild(firstDiv)
  set(`${fileName}Intro`, intro)
}
    </script>
</body>

</html>
